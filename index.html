<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gmail Widget v0.9</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }
    h2 { margin-top: 0; }
    button {
      background: #3a3a3a;
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #555; }
    .email-list {
      margin-top: 20px;
    }
    .email-item {
      background-color: #2c2c2c;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .email-subject {
      font-weight: bold;
    }
    .email-body {
      margin-top: 10px;
      display: none;
    }
    .account-selector {
      margin: 10px 0;
    }
    a {
      color: #4da6ff;
      word-break: break-word;
    }
    iframe {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>ðŸ“¬ Gmail Widget <small style="opacity:0.5;">v0.9</small></h2>
  <button onclick="handleAuthClick()">Iniciar sesiÃ³n con Google</button>
  <button onclick="fetchEmails()">ðŸ”„ Refrescar</button>
  <select id="accountSelect" class="account-selector" onchange="switchAccount()"></select>
  <div class="email-list" id="emailList">Cargando correos...</div>

  <script>
    const CLIENT_ID = '668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
    let accessToken = null;
    let activeAccount = null;

    function updateAccountSelector() {
      const select = document.getElementById("accountSelect");
      select.innerHTML = "";
      const tokens = JSON.parse(localStorage.getItem("gmail_tokens") || "{}");
      Object.keys(tokens).forEach(email => {
        const option = document.createElement("option");
        option.value = email;
        option.textContent = email;
        if (email === activeAccount) option.selected = true;
        select.appendChild(option);
      });
    }

    function switchAccount() {
      const email = document.getElementById("accountSelect").value;
      const tokens = JSON.parse(localStorage.getItem("gmail_tokens") || "{}");
      accessToken = tokens[email];
      activeAccount = email;
      fetchEmails();
    }

    function handleAuthClick() {
      const redirectUri = window.location.origin + window.location.pathname;
      const oauthURL = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=${SCOPES}`;

      const popup = window.open(oauthURL, "authPopup", "width=500,height=600");

      const pollTimer = setInterval(() => {
        try {
          if (!popup || popup.closed) {
            clearInterval(pollTimer);
          } else if (popup.location.href.startsWith(redirectUri)) {
            const hash = popup.location.hash.substr(1);
            const params = new URLSearchParams(hash);
            accessToken = params.get("access_token");
            popup.close();
            clearInterval(pollTimer);
            getUserEmail(accessToken).then(email => {
              const tokens = JSON.parse(localStorage.getItem("gmail_tokens") || "{}");
              tokens[email] = accessToken;
              localStorage.setItem("gmail_tokens", JSON.stringify(tokens));
              activeAccount = email;
              updateAccountSelector();
              fetchEmails();
            });
          }
        } catch (e) {}
      }, 500);
    }

    async function getUserEmail(token) {
      const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      return data.email;
    }

    async function fetchEmails() {
      if (!accessToken) return;
      const res = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages?maxResults=10', {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();
      const emails = await Promise.all((data.messages || []).map(msg => getEmail(msg.id)));
      displayEmails(emails);
    }

    async function getEmail(id) {
      const res = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${id}?format=full`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();
      const subjectHeader = data.payload.headers.find(h => h.name === 'Subject');
      const fromHeader = data.payload.headers.find(h => h.name === 'From');
      const subject = subjectHeader?.value || '(Sin asunto)';
      const from = fromHeader?.value || '(Desconocido)';
      let body = '';

      function parsePart(part) {
        if (part.mimeType === 'text/html' && part.body.data) {
          body = decodeURIComponent(escape(window.atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'))));
        } else if (part.parts) {
          part.parts.forEach(parsePart);
        }
      }

      parsePart(data.payload);
      return { subject, from, body };
    }

    function displayEmails(emails) {
      const container = document.getElementById("emailList");
      container.innerHTML = "";
      emails.forEach(email => {
        const item = document.createElement("div");
        item.className = "email-item";

        const subject = document.createElement("div");
        subject.className = "email-subject";
        subject.innerHTML = `${email.subject} <br><small>${email.from}</small>`;
        item.appendChild(subject);

        const body = document.createElement("div");
        body.className = "email-body";
        body.innerHTML = email.body;
        item.appendChild(body);

        item.addEventListener("click", () => {
          body.style.display = body.style.display === "none" ? "block" : "none";
        });

        container.appendChild(item);
      });
    }

    window.onload = () => {
      const tokens = JSON.parse(localStorage.getItem("gmail_tokens") || "{}");
      const emails = Object.keys(tokens);
      if (emails.length > 0) {
        accessToken = tokens[emails[0]];
        activeAccount = emails[0];
        updateAccountSelector();
        fetchEmails();
      }
      setInterval(fetchEmails, 300000); // cada 5 minutos
    };
  </script>
</body>
</html>
