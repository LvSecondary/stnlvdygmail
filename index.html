<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gmail Widget â€“ Beta v1.3</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    button {
      background-color: #1f1f1f;
      color: white;
      border: 1px solid #333;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
    }
    #emailList > div {
      background-color: #1e1e1e;
      border: 1px solid #333;
      margin-bottom: 8px;
      padding: 10px;
      cursor: pointer;
    }
    .email-content {
      display: none;
      margin-top: 8px;
      white-space: pre-wrap;
    }
    a {
      color: #4ea1f3;
    }
  </style>
</head>
<body>
  <h2>ðŸ“§ Gmail Widget â€“ Beta v1.3</h2>
  <div>
    <button onclick="signIn()">Iniciar sesiÃ³n con Google</button>
    <button onclick="refreshEmails()">ðŸ”„ Refrescar</button>
    <select id="accountSelect" onchange="switchAccount(this.value)">
      <option value="">Cambiar cuenta...</option>
    </select>
    <p id="currentEmail"></p>
  </div>
  <div id="emailList"></div>

  <script>
    const CLIENT_ID = "668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com";
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = "https://www.googleapis.com/auth/gmail.readonly";
    const TOKEN_KEY = "gmail_tokens_v1.3";

    let accounts = JSON.parse(localStorage.getItem(TOKEN_KEY)) || {};
    let currentEmail = null;
    let accessToken = null;

    async function signIn() {
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${encodeURIComponent(SCOPES)}&include_granted_scopes=true&prompt=select_account`;

      const popup = window.open(authUrl, "Gmail Login", "width=500,height=600");

      window.addEventListener("message", (e) => {
        if (e.data.type === "oauth-token") {
          handleToken(e.data.token);
        }
      });
    }

    function handleToken(token) {
      fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
        headers: { Authorization: "Bearer " + token }
      })
      .then(res => res.json())
      .then(user => {
        accounts[user.email] = token;
        localStorage.setItem(TOKEN_KEY, JSON.stringify(accounts));
        switchAccount(user.email);
      });
    }

    function switchAccount(email) {
      if (!accounts[email]) return;
      currentEmail = email;
      accessToken = accounts[email];
      document.getElementById("currentEmail").innerText = `ðŸ“¨ SesiÃ³n actual: ${email}`;
      loadEmails();
    }

    function refreshEmails() {
      if (currentEmail && accessToken) {
        loadEmails();
      }
    }

    function loadEmails() {
      document.getElementById("emailList").innerHTML = "ðŸ“¬ Cargando correos...";
      fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10", {
        headers: { Authorization: "Bearer " + accessToken }
      })
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById("emailList");
        list.innerHTML = "";
        const messages = data.messages || [];

        messages.forEach(msg => {
          fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=full`, {
            headers: { Authorization: "Bearer " + accessToken }
          })
          .then(res => res.json())
          .then(fullMsg => {
            const headers = fullMsg.payload.headers;
            const subject = headers.find(h => h.name === "Subject")?.value || "(Sin asunto)";
            const from = headers.find(h => h.name === "From")?.value || "(Desconocido)";
            const body = getBody(fullMsg.payload);
            const emailDiv = document.createElement("div");

            emailDiv.innerHTML = `<strong>${subject}</strong><br><em>${from}</em>`;
            const content = document.createElement("div");
            content.className = "email-content";
            content.innerHTML = sanitizeHTML(body);

            emailDiv.appendChild(content);
            emailDiv.addEventListener("click", () => {
              content.style.display = content.style.display === "block" ? "none" : "block";
            });

            list.appendChild(emailDiv);
          });
        });
      });
    }

    function getBody(payload) {
      const parts = payload.parts || [];
      let part = parts.find(p => p.mimeType === "text/html") || parts.find(p => p.mimeType === "text/plain");
      if (!part && payload.body && payload.body.data) {
        return decodeBase64(payload.body.data);
      }
      if (part && part.body && part.body.data) {
        return decodeBase64(part.body.data);
      }
      return "(Sin contenido)";
    }

    function decodeBase64(str) {
      return decodeURIComponent(escape(atob(str.replace(/-/g, "+").replace(/_/g, "/"))));
    }

    function sanitizeHTML(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      const links = div.querySelectorAll("a");
      links.forEach(link => {
        link.target = "_blank";
        link.rel = "noopener";
      });
      return div.innerHTML;
    }

    function restoreSession() {
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get("access_token");
        window.opener.postMessage({ type: "oauth-token", token }, "*");
        window.close();
        return;
      }

      const select = document.getElementById("accountSelect");
      Object.keys(accounts).forEach(email => {
        const option = document.createElement("option");
        option.value = email;
        option.innerText = email;
        select.appendChild(option);
      });

      if (Object.keys(accounts).length === 1) {
        switchAccount(Object.keys(accounts)[0]);
      }
    }

    restoreSession();

    setInterval(() => {
      if (currentEmail && accessToken) {
        loadEmails();
      }
    }, 300000); // 5 minutos
  </script>
</body>
</html>
