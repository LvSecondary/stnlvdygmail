<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gmail Widget - beta v0.2</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #eee; }
    #emails { margin-top: 1rem; }
    .email { border-bottom: 1px solid #444; padding: 0.5rem 0; }
    button { padding: 0.5rem 1rem; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>ðŸ“¬ Gmail Widget <small>(beta v0.3)</small></h2>
  <div id="g_id_onload"
       data-client_id="668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-scope="https://www.googleapis.com/auth/gmail.readonly">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-theme="outline"
       data-size="large"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <div id="emails"></div>

  <script>
    let token = null;

    function handleCredentialResponse(response) {
      token = response.credential;

      // Intercambiar por token de acceso
      fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          client_id: '668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com',
          code: response.code,
          redirect_uri: 'https://lvsecondary.github.io',
          code_verifier: '' // si estÃ¡s usando PKCE, debes incluirlo aquÃ­
        })
      })
      .then(res => res.json())
      .then(data => {
        token = data.access_token;
        fetchEmails();
        setInterval(fetchEmails, 10000);
      })
      .catch(err => console.error('Error al obtener token de acceso:', err));
    }

    function fetchEmails() {
      if (!token) return;

      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=5', {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const emailList = document.getElementById('emails');
        emailList.innerHTML = '';
        const ids = data.messages.map(msg => msg.id);

        ids.forEach(id => {
          fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${id}?format=metadata`, {
            headers: { Authorization: `Bearer ${token}` }
          })
          .then(res => res.json())
          .then(msg => {
            const subjectHeader = msg.payload.headers.find(h => h.name === 'Subject');
            const fromHeader = msg.payload.headers.find(h => h.name === 'From');
            const el = document.createElement('div');
            el.className = 'email';
            el.innerHTML = `<b>${subjectHeader?.value || '(Sin asunto)'}</b><br><small>${fromHeader?.value || ''}</small>`;
            emailList.appendChild(el);
          });
        });
      });
    }
  </script>
</body>
</html>
