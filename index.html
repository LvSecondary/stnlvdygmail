<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gmail Widget v1.2</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
    }
    .email {
      background-color: #1e1e1e;
      border: 1px solid #333;
      margin: 5px 0;
      padding: 10px;
      cursor: pointer;
    }
    .email-body {
      display: none;
      margin-top: 5px;
      white-space: pre-wrap;
    }
    a {
      color: #4fc3f7;
    }
    .account-btn {
      background-color: #333;
    }
  </style>
</head>
<body>
  <h2>ðŸ“© Gmail Widget v1.2</h2>
  <div id="account-info"></div>
  <button onclick="startAuth()">Iniciar sesiÃ³n con Google</button>
  <button onclick="refreshEmails()">ðŸ”„ Refrescar correos</button>
  <div id="accounts"></div>
  <hr>
  <div id="emails">Cargando...</div>

  <script>
    const CLIENT_ID = "668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com";
    const REDIRECT_URI = "https://lvsecondary.github.io/stnlvdygmail/";
    const SCOPES = "https://www.googleapis.com/auth/gmail.readonly";
    const STATE_KEY = "gmail_widget_tokens";

    const getStoredTokens = () => JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
    const saveStoredTokens = tokens => localStorage.setItem(STATE_KEY, JSON.stringify(tokens));

    let accessToken = null;
    let currentAccount = null;

    function startAuth() {
      const authWindow = window.open(
        `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${encodeURIComponent(SCOPES)}&prompt=consent`,
        "authPopup",
        "width=500,height=600"
      );

      const pollTimer = setInterval(() => {
        try {
          if (!authWindow || authWindow.closed) {
            clearInterval(pollTimer);
            return;
          }

          const url = authWindow.location.href;
          if (url.startsWith(REDIRECT_URI) && url.includes("access_token")) {
            const params = new URLSearchParams(url.split("#")[1]);
            const token = params.get("access_token");
            authWindow.close();
            clearInterval(pollTimer);
            fetchUserInfo(token);
          }
        } catch (e) {}
      }, 500);
    }

    async function fetchUserInfo(token) {
      const res = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (data.email) {
        const tokens = getStoredTokens();
        tokens[data.email] = token;
        saveStoredTokens(tokens);
        currentAccount = data.email;
        accessToken = token;
        updateAccountInfo();
        loadEmails();
      }
    }

    function updateAccountInfo() {
      document.getElementById("account-info").innerText = currentAccount
        ? `Conectado como: ${currentAccount}`
        : "No has iniciado sesiÃ³n.";
      renderAccountSwitcher();
    }

    function renderAccountSwitcher() {
      const container = document.getElementById("accounts");
      const tokens = getStoredTokens();
      container.innerHTML = Object.keys(tokens).map(email => `
        <button class="account-btn" onclick="switchAccount('${email}')">${email}</button>
      `).join("");
    }

    function switchAccount(email) {
      const tokens = getStoredTokens();
      if (tokens[email]) {
        currentAccount = email;
        accessToken = tokens[email];
        updateAccountInfo();
        loadEmails();
      }
    }

    async function loadEmails() {
      if (!accessToken) return;
      const res = await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10", {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();
      const emailsDiv = document.getElementById("emails");
      emailsDiv.innerHTML = "";

      if (!data.messages || data.messages.length === 0) {
        emailsDiv.innerHTML = "<p>No hay correos recientes.</p>";
        return;
      }

      for (const msg of data.messages) {
        const msgRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=full`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const msgData = await msgRes.json();
        const headers = msgData.payload.headers;
        const from = headers.find(h => h.name === "From")?.value || "Desconocido";
        const subject = headers.find(h => h.name === "Subject")?.value || "(Sin asunto)";
        const snippet = msgData.snippet;

        const div = document.createElement("div");
        div.className = "email";
        div.innerHTML = `
          <strong>${subject}</strong><br>
          <em>${from}</em>
          <div class="email-body">${snippet.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')}</div>
        `;
        div.onclick = () => {
          const body = div.querySelector(".email-body");
          body.style.display = body.style.display === "none" ? "block" : "none";
        };
        emailsDiv.appendChild(div);
      }
    }

    function refreshEmails() {
      if (accessToken) loadEmails();
    }

    window.onload = () => {
      const tokens = getStoredTokens();
      const emails = Object.keys(tokens);
      if (emails.length > 0) {
        currentAccount = emails[0];
        accessToken = tokens[currentAccount];
        updateAccountInfo();
        loadEmails();
      } else {
        document.getElementById("emails").innerHTML = "Inicia sesiÃ³n para ver tus correos.";
      }
    };
  </script>
</body>
</html>
