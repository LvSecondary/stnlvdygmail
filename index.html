<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“§ Gmail Widget v1.0</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    button {
      background-color: #333;
      color: #fff;
      border: none;
      padding: 6px 12px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #444;
    }
    .email {
      background: #222;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .email:hover {
      background-color: #333;
    }
    .email-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .email-body {
      display: none;
      margin-top: 5px;
      white-space: pre-wrap;
    }
    .account-buttons {
      margin-bottom: 10px;
    }
    a {
      color: #4EA5EC;
      text-decoration: underline;
    }
    img {
      max-width: 100%;
      margin-top: 5px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“¨ Widget Gmail v1.0</h1>
  <div class="account-buttons" id="accountButtons"></div>
  <div id="g_id_onload"
       data-client_id="TU_CLIENT_ID_AQUI"
       data-auto_prompt="false"
       data-callback="onSignIn">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="filled_black"
       data-text="signin_with"
       data-size="large"
       data-logo_alignment="left">
  </div>
  <button onclick="refreshEmails()">ðŸ”„ Actualizar</button>
  <div id="emails"></div>

  <script>
    const accounts = {};
    let currentAccount = null;

    function onSignIn(response) {
      const credential = response.credential;
      const payload = JSON.parse(atob(credential.split('.')[1]));
      const email = payload.email;

      if (!accounts[email]) {
        accounts[email] = { credential };
        const btn = document.createElement('button');
        btn.textContent = email;
        btn.onclick = () => {
          currentAccount = email;
          refreshEmails();
        };
        document.getElementById('accountButtons').appendChild(btn);
      }

      currentAccount = email;
      localStorage.setItem('gmail_tokens', JSON.stringify(accounts));
      refreshEmails();
    }

    function loadStoredAccounts() {
      const stored = localStorage.getItem('gmail_tokens');
      if (stored) {
        const parsed = JSON.parse(stored);
        for (let email in parsed) {
          accounts[email] = parsed[email];
          const btn = document.createElement('button');
          btn.textContent = email;
          btn.onclick = () => {
            currentAccount = email;
            refreshEmails();
          };
          document.getElementById('accountButtons').appendChild(btn);
        }
        currentAccount = Object.keys(parsed)[0];
        refreshEmails();
      }
    }

    async function refreshEmails() {
      if (!currentAccount) return;

      document.getElementById('emails').innerHTML = "<p>Cargando correos...</p>";

      try {
        const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=10', {
          headers: {
            Authorization: `Bearer ${accounts[currentAccount].access_token}`
          }
        });

        const data = await response.json();

        const emailContainer = document.getElementById('emails');
        emailContainer.innerHTML = '';

        for (let msg of data.messages || []) {
          const emailRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=full`, {
            headers: {
              Authorization: `Bearer ${accounts[currentAccount].access_token}`
            }
          });
          const emailData = await emailRes.json();
          const headers = emailData.payload.headers;
          const subject = headers.find(h => h.name === 'Subject')?.value || '(Sin asunto)';
          const from = headers.find(h => h.name === 'From')?.value || '';
          const parts = emailData.payload.parts || [];
          let body = '';

          function decodeBase64(input) {
            return decodeURIComponent(escape(atob(input.replace(/-/g, '+').replace(/_/g, '/'))));
          }

          for (let part of parts) {
            if (part.mimeType === 'text/html' || part.mimeType === 'text/plain') {
              if (part.body.data) {
                body = decodeBase64(part.body.data);
                break;
              }
            }
          }

          const emailDiv = document.createElement('div');
          emailDiv.className = 'email';

          const title = document.createElement('div');
          title.className = 'email-title';
          title.innerHTML = `<strong>${subject}</strong> <br><small>${from}</small>`;
          emailDiv.appendChild(title);

          const bodyDiv = document.createElement('div');
          bodyDiv.className = 'email-body';
          bodyDiv.innerHTML = body;

          title.addEventListener('click', () => {
            bodyDiv.style.display = bodyDiv.style.display === 'none' ? 'block' : 'none';
          });

          emailDiv.appendChild(bodyDiv);
          emailContainer.appendChild(emailDiv);
        }
      } catch (err) {
        document.getElementById('emails').innerHTML = `<p style="color:red;">Error al cargar emails: ${err.message}</p>`;
      }
    }

    window.onload = () => {
      loadStoredAccounts();
    };
  </script>
</body>
</html>
