<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gmail Widget â€“ beta v0.3</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 1rem; }
    button { padding: 0.5rem 1rem; background: #333; border: none; color: white; cursor: pointer; margin-top: 1rem; }
    .email { border-bottom: 1px solid #444; margin: 1rem 0; padding-bottom: 0.5rem; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>ðŸ“¬ Gmail Widget <small>(beta v0.3)</small></h2>

  <button onclick="getToken()">ðŸ”“ Conectar con Gmail</button>

  <div id="emails"></div>

  <script>
    let tokenClient;
    let accessToken = null;

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/gmail.readonly',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          fetchEmails();
          setInterval(fetchEmails, 10000);
        }
      });
    };

    function getToken() {
      tokenClient.requestAccessToken();
    }

    function fetchEmails() {
      if (!accessToken) return;

      fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=5', {
        headers: {
          Authorization: `Bearer ${accessToken}`
        }
      })
      .then(res => res.json())
      .then(data => {
        const emailList = document.getElementById('emails');
        emailList.innerHTML = '';

        if (!data.messages || data.messages.length === 0) {
          emailList.innerHTML = '<p>No hay correos recientes.</p>';
          return;
        }

        data.messages.forEach(msg => {
          fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}?format=metadata`, {
            headers: { Authorization: `Bearer ${accessToken}` }
          })
          .then(res => res.json())
          .then(msgData => {
            const headers = msgData.payload.headers;
            const subject = headers.find(h => h.name === 'Subject')?.value || '(Sin asunto)';
            const from = headers.find(h => h.name === 'From')?.value || '';
            const el = document.createElement('div');
            el.className = 'email';
            el.innerHTML = `<strong>${subject}</strong><br><small>${from}</small>`;
            emailList.appendChild(el);
          });
        });
      });
    }
  </script>
</body>
</html>
