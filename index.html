<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“© Gmail Widget - v0.9.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 12px;
      margin: 4px;
      border: none;
      border-radius: 4px;
      background-color: #1a73e8;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #1558b0;
    }
    .email-item {
      border-bottom: 1px solid #333;
      padding: 10px 0;
      cursor: pointer;
    }
    .email-details {
      display: none;
      margin-top: 10px;
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 5px;
    }
    a {
      color: #4ea1f3;
      word-break: break-word;
    }
    select {
      margin-left: 10px;
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>ðŸ“¬ Gmail Widget - v0.9.1</h1>
  <button onclick="handleAuthClick()">Iniciar sesiÃ³n</button>
  <button onclick="handleSignOutClick()">Cerrar sesiÃ³n</button>
  <button onclick="refreshEmails()">ðŸ”„ Refrescar correos</button>
  <select id="accountSelector" onchange="switchAccount(this.value)">
    <option value="">Cambiar de cuenta</option>
  </select>
  <div id="content"></div>

  <script>
    const CLIENT_ID = '668304089967-0hphsaua88ml50hubej24s4dpqf2ff83.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDFz7dA4Lh9NCo6gPPrbD_PHw4N4vi26jQ';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send';

    let currentAccount = null;
    const tokens = {};

    function gapiLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: [DISCOVERY_DOC], scope: SCOPES }).then(() => {
        const auth = gapi.auth2.getAuthInstance();
        auth.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(auth.isSignedIn.get());
      });
    }

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        const user = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = user.getBasicProfile();
        const email = profile.getEmail();
        const token = user.getAuthResponse().access_token;
        tokens[email] = token;
        localStorage.setItem('gmail_tokens', JSON.stringify(tokens));
        addAccountOption(email);
        currentAccount = email;
        listEmails();
      });
    }

    function handleSignOutClick() {
      gapi.auth2.getAuthInstance().signOut();
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        const stored = JSON.parse(localStorage.getItem('gmail_tokens') || '{}');
        Object.assign(tokens, stored);
        const user = gapi.auth2.getAuthInstance().currentUser.get();
        const email = user.getBasicProfile().getEmail();
        if (!tokens[email]) {
          tokens[email] = user.getAuthResponse().access_token;
          localStorage.setItem('gmail_tokens', JSON.stringify(tokens));
        }
        addAccountOption(email);
        currentAccount = email;
        listEmails();
      }
    }

    function addAccountOption(email) {
      const sel = document.getElementById('accountSelector');
      if (![...sel.options].some(opt => opt.value === email)) {
        const opt = document.createElement('option');
        opt.value = email;
        opt.textContent = email;
        sel.appendChild(opt);
      }
    }

    function switchAccount(email) {
      if (tokens[email]) {
        currentAccount = email;
        listEmails();
      } else {
        alert('Primero inicia sesiÃ³n con esa cuenta.');
      }
    }

    function refreshEmails() {
      if (currentAccount) listEmails();
    }

    function listEmails() {
      gapi.client.gmail.users.messages.list({ userId: 'me', maxResults: 10 }).then(res => {
        const messages = res.result.messages;
        if (!messages || messages.length === 0) {
          document.getElementById('content').innerHTML = '<p>No hay correos.</p>';
          return;
        }

        const promises = messages.map(msg => gapi.client.gmail.users.messages.get({ userId: 'me', id: msg.id }));

        Promise.all(promises).then(results => {
          const html = results.map(res => {
            const headers = res.result.payload.headers;
            const subject = (headers.find(h => h.name === 'Subject') || {}).value || '(Sin asunto)';
            const from = (headers.find(h => h.name === 'From') || {}).value || '';
            const date = (headers.find(h => h.name === 'Date') || {}).value || '';
            const body = getBody(res.result.payload);
            const id = res.result.id;
            return `
              <div class="email-item" onclick="toggleEmail('${id}')">
                <strong>${subject}</strong><br>
                <small>${from} â€“ ${date}</small>
                <div class="email-details" id="email-${id}">${body}</div>
              </div>`;
          }).join('');
          document.getElementById('content').innerHTML = html;
        });
      });
    }

    function toggleEmail(id) {
      const el = document.getElementById('email-' + id);
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function getBody(payload) {
      let body = '';
      if (payload.parts) {
        for (const part of payload.parts) {
          if (part.mimeType === 'text/html' && part.body.data) {
            body = atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            break;
          }
        }
      } else if (payload.body && payload.body.data) {
        body = atob(payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
      }
      return body.replace(/(https?:\/\/[^\s"<]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    window.onload = () => {
      gapiLoad();
    };
  </script>
</body>
</html>
